{% extends "base.html" %}
{% block title %}<title>My Profile - {{ SITE_NAME }}</title>{% endblock %}
{% block dashboard_stat %}
<!-- Content Header (Page header) -->
<section class="content-header">
    <h1>
        Profile
        <small>Edit my profile</small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="{{ url_for('dashboard.dashboard') }}"><i class="fa fa-dashboard"></i>Home</a></li>
        <li class="active">My Profile</li>
    </ol>
</section>
{% endblock %}
{% block content %}
<section class="content">
    <div class="row">
        <div class="col-lg-12">
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title">Edit my profile{%  if session['authentication_type'] != 'LOCAL' %} [Disabled -
                        Authenticated externally]{% endif %}</h3>
                </div>
                <div class="box-body">
                    <!-- Custom Tabs -->
                    <div class="nav-tabs-custom" id="tabs">
                        <ul class="nav nav-tabs">
                            <li class="active"><a href="#tabs-personal" data-toggle="tab">Personal
                                    Info</a></li>
                            {%  if session['authentication_type'] == 'LOCAL' %}
                            <li><a href="#tabs-password" data-toggle="tab">Change Password</a></li>
                            {% endif %}
                            {%  if session['authentication_type'] in ['LOCAL', 'LDAP'] %}
                            <li><a href="#tabs-authentication" data-toggle="tab">Authentication</a></li>
                            {% endif %}
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane active" id="tabs-personal">
                                <form role="form" method="post" action="{{ user_profile }}">
                                    <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                                    <div class="form-group">
                                        <label for="firstname">First Name</label> <input type="text"
                                            class="form-control" name="firstname" id="firstname"
                                            placeholder="{{ current_user.firstname }}"
                                            {%  if session['authentication_type'] != 'LOCAL' %}disabled{% endif %}>
                                    </div>
                                    <div class="form-group">
                                        <label for="lastname">Last Name</label> <input type="text" class="form-control"
                                            name="lastname" id="lastname" placeholder="{{ current_user.lastname }}"
                                            {%  if session['authentication_type'] != 'LOCAL' %}disabled{% endif %}>
                                    </div>
                                    <div class="form-group">
                                        <label for="email">E-mail</label> <input type="email" class="form-control"
                                            name="email" id="email" placeholder="{{ current_user.email }}"
                                            {%  if session['authentication_type'] != 'LOCAL' %}disabled{% endif %}>
                                    </div>{%  if session['authentication_type'] == 'LOCAL' %}
                                    <div class="form-group">
                                        <button type="submit" class="btn btn-flat btn-primary">Submit</button>
                                    </div>{% endif %}
                                </form>
                            </div>
                            {% if session['authentication_type'] == 'LOCAL' %}

                            <div class="tab-pane" id="tabs-password">
                                {% if error %}
                                <div class="alert alert-danger alert-dismissible">
                                  <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                                  {{ error }}
                                </div>
                                {% endif %}
                                {% if not current_user.password %}
                                Your account password is managed via LDAP which isn't supported to change here.
                                {% else %}
                                <form action="{{ user_profile }}" method="post">
                                    <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                                    <div class="form-group">
                                        <label for="password">New Password</label> 
                                            <input type="password"
                                            class="form-control" name="password" id="newpassword" required />
                                    </div>
                                    <div id="policy-err" style='color: #df5948;'></div>
                                    <div class="form-group has-feedback">
                                        <label for="rpassword">Re-type New Password</label> 
                                        <input type="password"
                                            data-match="#newpassword" data-match-error="Password confirmation does not match"
                                            class="form-control" name="rpassword" id="rpassword" required />
                                            <span class="help-block with-errors"></span>
                                            <span class="glyphicon form-control-feedback"></span>
                                    </div>
                                    <div id="retype-err" style='color: #df5948;'></div>
                                    <div class="form-group">
                                        <button type="submit" id="pwd-submit" class="btn btn-flat btn-primary btn-block" disabled>Change Password</button>
                                    </div>
                                </form>
                                {% endif %}
                            </div>
                            {% endif %}
                            <!-- {% if session['authentication_type'] in ['LOCAL', 'LDAP'] %} -->
                            <div class="tab-pane" id="tabs-authentication">
                                <form action="{{ user_profile }}" method="post">
                                    <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
                                    <div class="form-group">
                                        <input type="checkbox" id="otp_toggle" class="otp_toggle"
                                            {% if current_user.otp_secret %}checked{% endif %}>
                                        <label for="otp_toggle">Enable Two Factor Authentication</label>
                                        {% if current_user.otp_secret %}
                                        <div id="token_information">
                                            <p><img id="qrcode" src="{{ url_for('user.qrcode') }}"></p>
                                            You can use Google Authenticator (<a target="_blank"
                                                href="https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2">Android</a>
                                            - <a target="_blank"
                                                href="https://apps.apple.com/us/app/google-authenticator/id388497605">iOS</a>)
                                            or FreeOTP (<a target="_blank"
                                                href="https://play.google.com/store/apps/details?id=org.fedorahosted.freeotp&hl=en">Android</a>
                                            - <a target="_blank"
                                                href="https://itunes.apple.com/en/app/freeotp-authenticator/id872559395?mt=8">iOS</a>)
                                            on your smartphone to scan the QR code.
                                            <br />
                                            <font color="red"><strong><i>Make sure only you can see this QR Code and
                                                        nobody can capture it.</i></strong></font>
                                        </div>
                                        {% endif %}
                                    </div>
                                </form>
                            </div>
                            <!-- {% endif %} -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}
{% block extrascripts %}
<script>
    {% if change_pass_tab %}
        {% if change_pass_tab == True %}
            $('#tabs a[href="#tabs-password"]').tab('show')
        {% endif %}
    {% else %}
        $(function () {
            $('#tabs').tabs({
                // add url anchor tags
                activate: function (event, ui) {
                    window.location.hash = ui.newPanel.attr('id');
                }
            });
            // re-set active tab (ui)
            var activeTabIdx = $('#tabs').tabs('option', 'active');
            $('#tabs li:eq(' + activeTabIdx + ')').tab('show')
        });
    {% endif %}



    // initialize pretty checkboxes
    $('.otp_toggle').iCheck({
        checkboxClass: 'icheckbox_square-blue',
        increaseArea: '20%'
    });

    // handle checkbox toggling
    $('.otp_toggle').on('ifToggled', function (event) {
        var enable_otp = $(this).prop('checked');
        var postdata = {
            'action': 'enable_otp',
            'data': {
                'enable_otp': enable_otp
            },
            '_csrf_token': '{{ csrf_token() }}'
        };
        applyChanges(postdata, $SCRIPT_ROOT + '/user/profile', false, true);
    });
    


    {% if SETTING.get('zxcvbn_enabled') == false %}
    // handling password complexity requirements message and password comparison
    $(':input').on('keyup', function() {
        var rpass = document.getElementById('rpassword').value;
        var input = document.getElementById('newpassword');
        var pass = input.value;
        if (rpass != pass) {
            document.getElementById('pwd-submit').disabled = true;
            document.getElementById('retype-err').innerHTML = 'Password confirmation does not match';
        }
        else {
            document.getElementById('retype-err').innerHTML = '';
        }
        var pwd_len = parseInt("{{ SETTING.get('pwd_min_len') }}");
        var n_upper = parseInt("{{ SETTING.get('pwd_min_uppercase') }}");
        var n_lower = parseInt("{{ SETTING.get('pwd_min_lowercase') }}");
        var n_digits = parseInt("{{ SETTING.get('pwd_min_digits') }}");
        var n_special = parseInt("{{ SETTING.get('pwd_min_special') }}");
        var must_not_contain = "{{ SETTING.get('pwd_must_not_contain') }}";
        var pattern = "^(?=(?:.*[0-9]){" + n_digits + ",})(?=(?:.*[a-z]){" + n_lower + ",})(?=(?:.*[A-Z]){" + n_upper + ",})(?=(?:.*[[!@#$%^&*()_+]){" + n_special + ",}).+$";

        var PasswordRegEx = new RegExp(pattern, 'm');
        var upper_found = 0;
        var lower_found = 0;
        var digits_found = 0;
        var special_found = 0;
        var lower_pattern = /[a-z]/g;
        var upper_pattern = /[A-Z]/g;
        var digits_pattern = /[0-9]/g;
        var special_pattern = /[[!@#$%^&*()_+]/g;
        for (var i = 0; i < pass.length; i++) {
        if (pass[i].match(special_pattern)) special_found++;
        else if (pass[i].match(lower_pattern)) lower_found++;
        else if (pass[i].match(upper_pattern)) upper_found++;
        else if (pass[i].match(digits_pattern)) digits_found++;
        }
        var msg = "";
        if (pass.length < pwd_len) msg += 'at least ' + pwd_len + ' character(s)<br>'
        if (lower_found < n_lower) msg += 'at least ' + n_lower + ' lowercase character(s)<br>';
        if (upper_found < n_upper) msg += 'at least ' + n_upper + ' uppercase character(s)<br>';
        if (digits_found < n_digits) msg += 'at least ' + n_digits + ' digit(s)<br>';
        if (special_found < n_special) msg += 'at least ' + n_special + ' special character(s) from [!@#$%^&*()_+<br>';
        if (msg.length != 0) msg = "Password must have: <br>" + msg;

        // must not contain
        must_not_contain_msg = "";
        var fname = "{{ user_info.firstname }}";
        var lname = "{{ user_info.lastname }}";
        var email = "{{ user_info.email }}";
        var username = "{{ user_info.username }}";
        if (must_not_contain.search("username") != -1 && pass.search(username) != -1) must_not_contain_msg += " username<br>"
        if (must_not_contain.search("firstname") != -1 && pass.search(fname) != -1) must_not_contain_msg += " firstname<br>"
        if (must_not_contain.search("lastname") != -1 && pass.search(lname) != -1) must_not_contain_msg += " lastname<br>"
        if (must_not_contain.search("email") != -1 && pass.search(email) != -1) must_not_contain_msg += " email<br>"
        if (must_not_contain_msg.length != 0) must_not_contain_msg = "Password must not contain: <br>" + must_not_contain_msg
        var x = document.getElementById('policy-err');
        x.innerHTML = msg + must_not_contain_msg
        if (msg != "") {
            document.getElementById('pwd-submit').disabled = true; 
        }
        else if (msg.length == 0 && pass.length != 0 && rpass == pass){ 
            document.getElementById('pwd-submit').disabled = false;
        }
    });
    {% else %}

    var timer = null;
    function send_pass() {
      var fname = document.getElementById('firstname').value;
      var lname = document.getElementById('lastname').value;
      var email = document.getElementById('email').value;
      var username = document.getElementById('username').value;
      var password = document.getElementById('password').value;

      $.ajax({
          url: "/ratepassword",
          // headers: { "X-CSRFToken": getCookie("csrftoken") },
          type: "post",
          data : {'fname': fname, 'lname': lname, 'email' : email, 'username' : username, 'password': password},
          success: function(response) {
            console.log('Submission was successful.');
            console.log("Resp = " , response)
            console.log('sccess')
            var x = document.getElementById('policy-err');
            // x.innerHTML = response['feedback'];
            x.innerHTML = "<ul>";
            for (let i = 0; i < response['feedback'].length; i++) {
              x.innerHTML += "<li>" + response['feedback'][i] + "</li>";
            }
            x.innerHTML += "</ul>"
            var strength;
            switch (response['strength']) {
              case '':
                strength = ''; // no password was given
                break;
              case 'very weak':
                strength = "<small class='progress-bar bg-danger' style='background-color: #a50021; width: 25%'>Very weak</small>";
                break;
              case 'weak':
                strength = "<small class='progress-bar bg-danger' style='background-color: #f7a73e;width: 50%'>Weak</small>";
                break;
              case 'medium':
                strength = "<small class='progress-bar bg-warning' style='background-color: #a0cb89; width: 75%'>Medium</small>";
                break;
              case 'strong':
                strength = "<small class='progress-bar bg-success' style='background-color: #2e8b57; width: 100%'>Strong</small>";
                break;
              }
              var y = document.getElementById('password-text')
              y.innerHTML = strength;

              if (response['feedback'] != "") {
                document.getElementById('register').disabled = true; 
                // $('#pass-feedback').addClass("has-error");
              }
              else { 
                document.getElementById('register').disabled = false;
                // $('#pass-feedback').addClass("has-success");
              }
              
          },
          error: function(xhr) {
              console.log("Ajax call to rate pass, has failed")
          }
        });
      timer = null; // turn the timer off
    }
    // handling password complexity requirements message
    $(':input').on('keyup', function() {

      var seconds = 1;
      if (timer == null) {  // if user typed sth and timer is not running, then start one
        timer = setTimeout(send_pass, seconds*1000);
      }
      else { // if user typed sth and timer is still up and running,then reset timer
        clearTimeout(timer);
        timer = null; 
        timer = setTimeout(send_pass, seconds*1000);
      }
    });
    {% endif %}
</script>
{% endblock %}
